<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ESP8266 Interface</title>
    <script>
        // Function to send commands to the server
        function sendCommand1() {
            const commandInput = document.getElementById('command');
            const valueInput = document.getElementById('value');
            const command = commandInput.value;
            const value = valueInput.value;

            fetch('/send_command/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: command, value: value })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('response').innerText = JSON.stringify(data, null, 2);
                // Clear input fields after sending
                commandInput.value = '';
                valueInput.value = '';
            })
            .catch(error => console.error('Error sending command:', error));
        }
        function sendCommand2(command, value) {
            fetch('/send_command/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: command, value: value })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('response').innerText = JSON.stringify(data, null, 2);
            })
            .catch(error => console.error('Error sending command:', error));
        }
        // Function to fetch and display sensor data
        async function fetchSensorData() {
    try {
        const response = await fetch('/get_sensor_data/');
        const data = await response.json();
        if (data.status === 'success' && data.data.length > 0) {
            const latestData = data.data[0];
            
            // –ü–ª–∞–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
            animateValue('sensorValue1', latestData.sensor_value_1);
            animateValue('sensorValue2', latestData.sensor_value_2);
            animateValue('sensorValue3', latestData.sensor_value_3);
        }
    } catch (error) {
        console.error('Error fetching sensor data:', error);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏ —á–∏—Å–µ–ª
function animateValue(elementId, newValue) {
    const element = document.getElementById(elementId);
    let current = parseFloat(element.innerText) || 0;
    const delta = (newValue - current) / 10; // –°–∫–æ—Ä–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏

    const update = () => {
        current += delta;
        if (Math.abs(newValue - current) < Math.abs(delta)) {
            current = newValue;
        } else {
            requestAnimationFrame(update);
        }
        element.innerText = Math.round(current);
    };
    
    requestAnimationFrame(update);
}

// –£–≤–µ–ª–∏—á–∏–º —á–∞—Å—Ç–æ—Ç—É –æ–ø—Ä–æ—Å–∞ –¥–æ 1 —Å–µ–∫—É–Ω–¥—ã
setInterval(fetchSensorData, 1000);
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sensor-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
    </style>
</head>
<body class="container mt-4">
    <h1 class="text-center mb-4">–ê–≤—Ç–æ–ø–æ–ª–∏–≤ üåø</h1>

    <div class="row">
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ -->
        <div class="col-md-4">
            <div class="sensor-card">
                <h5>üíß –£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã</h5>
                <h1 id="sensorValue1" class="display-4">0</h1>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="sensor-card">
                <h5>üå± –í–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã</h5>
                <h1 id="sensorValue2" class="display-4">0</h1>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="sensor-card">
                <h5>üîÜ –û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å</h5>
                <h1 id="sensorValue3" class="display-4">0</h1>
            </div>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
    <div class="chart-container">
        <canvas id="sensorChart"></canvas>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="card mt-4">
        <div class="card-body">
            <h4 class="card-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h4>
            
            <div class="btn-group" role="group">
                <button onclick="sendCommand2('turn_on_led', 1)" class="btn btn-success">
                    –í–∫–ª—é—á–∏—Ç—å –Ω–∞—Å–æ—Å ‚úÖ
                </button>
                <button onclick="sendCommand2('turn_off_led', 1)" class="btn btn-danger">
                    –í—ã–∫–ª—é—á–∏—Ç—å –Ω–∞—Å–æ—Å ‚ùå
                </button>
            </div>
        </div>
    </div>

    <!-- Form to send commands -->
    <h2>Send Command to ESP8266</h2>
    <form onsubmit="event.preventDefault(); sendCommand1();">
        <input type="text" id="command" placeholder="Command (e.g., turn_on_led)" required>
        <input type="number" id="value" placeholder="Value (e.g., 1)" required>
        <button type="submit">Send Command</button>
    </form>
<!-- Buttons for sending specific commands -->
<h2>Control LED</h2>
<button onclick="sendCommand2('turn_on_led', 1)">Turn On LED</button>
<button onclick="sendCommand2('turn_off_led', 1)">Turn Off LED</button>

    <!-- Display server response -->
    <h2>Server Response</h2>
    <pre id="response"></pre>

    <!-- Display sensor data from ESP8266 -->
    <h2>ESP8266 Sensor Data</h2>
    <p>Sensor 1 Value: <span id="sensorValue1"></span></p>
    <p>Sensor 2 Value: <span id="sensorValue2"></span></p>
    <p>Sensor 3 Value: <span id="sensorValue3"></span></p>
    <pre id="sensorData"></pre>

    <h2>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞–∑–∞–Ω–∏–π</h2>
    <canvas id="sensorChart" width="400" height="200"></canvas>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
        const ctx = document.getElementById('sensorChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
                datasets: [{
                    label: '–£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                },
                {
                    label: '–í–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    tension: 0.1
                },
                {
                    label: '–û—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å',
                    data: [],
                    borderColor: 'rgb(54, 162, 235)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        async function updateChart() {
            const response = await fetch('/get_sensor_data/');
            const data = await response.json();
            
            if (data.status === 'success') {
                const sensorData = data.data.slice(0, 20); // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 –∑–∞–ø–∏—Å–µ–π
                
                chart.data.labels = sensorData.map(d => 
                    new Date(d.timestamp).toLocaleTimeString()
                );
                
                chart.data.datasets[0].data = sensorData.map(d => d.sensor_value_1);
                chart.data.datasets[1].data = sensorData.map(d => d.sensor_value_2);
                chart.data.datasets[2].data = sensorData.map(d => d.sensor_value_3);
                
                chart.update();
            }
        }

        // –û–±–Ω–æ–≤–ª—è—Ç—å –≥—Ä–∞—Ñ–∏–∫ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(updateChart, 5000);
    </script>
</body>
</html>